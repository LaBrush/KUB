<?php

namespace Kub\EDTBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Kub\EDTBundle\Entity\Horaire ;

/**
 * HoraireRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HoraireRepository extends EntityRepository
{

	public function findConflictualCours(Horaire $horaire)
	{
		$query = $this->_em->createQuery(
			"SELECT DISTINCT h, j
			 FROM KubEDTBundle:Horaire h 
			 JOIN h.jour j
			 JOIN h.cours c
			 JOIN c.groupes g 
			 JOIN g.eleves e

			 WHERE h.id != :id 
			 AND 
			 (
				 (
				 	h.debut BETWEEN :debut AND :fin
				 OR h.fin   BETWEEN :debut AND :fin 
				 ) OR (
				     :debut  BETWEEN h.debut AND h.fin
				 AND :fin    BETWEEN h.debut AND h.fin
				 )  
			 )
			  AND j.id = :jour
			  AND c.id != :cours 
			"
		)
		->setParameter('id', $horaire->getId())
		->setParameter('debut', $horaire->getDebut())
		->setParameter('fin', $horaire->getFin())
		->setParameter('jour', $horaire->getJour()->getId())
		->setParameter('cours', $horaire->getCours()->getId())
		;	

  		return $query->getResult();
	}

}
